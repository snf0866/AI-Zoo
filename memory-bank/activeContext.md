# Active Context

## Current Work Focus
現在の焦点は、AI Zoo Discord Botプロジェクトのデータベース初期化処理の改善です。ボット起動時にデータベースの初期化がうまく動作していない問題を修正しました。

## Recent Changes
- データベース初期化処理の改善:
  - `database.py`: 
    - `Float`型を正しくインポート
    - データベースディレクトリの存在確認と作成機能を追加
    - エラーハンドリングを強化し、初期化結果を返すように修正
  - `base_bot.py`: 
    - データベース初期化状態を追跡するフラグを追加
    - 初期化処理の結果を確認するメカニズムを追加
    - データベースが初期化されていない場合はログ記録をスキップするオプションを追加
  - `llm_service.py`: 
    - ログ記録をスキップするオプションを追加
    - ドキュメントを更新

- READMEファイルをプロジェクトルートに移動:
  - 以前は`ai-zoo-discord-bots/README.md`に配置されていたREADMEファイルをプロジェクトルート（`/README.md`）に移動
  - プロジェクト全体の説明文書としてアクセスしやすくするための変更

- Discord Botのボット間会話の自然さを改善:
  - `base_role.txt`: 他のボットへの応答スタイルに関する具体的な指示を追加
    - 「ご指摘の通りですね」などの同意から始めるのではなく、質問に直接答えるよう指示
    - 相手の発言内容を先に知っていたかのような表現を避けるよう指示
  - `utils/conversation.py`: 会話フォーマットの改善
    - `format_for_anthropic`メソッド: 他のボットからのメッセージを「Human」ではなく「Bot (名前)」として表示
    - `format_for_openai`メソッド: 同様に他のボットからのメッセージを区別するためのプレフィックスを追加
  - `base_bot.py`: システムプロンプトの動的調整機能を追加
    - `_adjust_system_prompt_for_sender`メソッド: 送信者に基づいてシステムプロンプトを調整
    - 他のボットからのメッセージに応答する場合、追加の指示を挿入

- 以前の変更（コード構造改善）:
  - `base_bot.py`: 共通機能を持つ基底クラス`BaseDiscordBot`を実装
  - `main_bot.py`: 基底クラスを継承するように修正
  - `secondary_bot.py`: 基底クラスを継承するように修正
  - 共通化された機能:
    - ボットの初期化と設定
    - イベントハンドリング
    - キャラクター設定の読み込み
    - メッセージ応答処理
    - クールダウン管理
    - 自己紹介メッセージ生成
  - 拡張ポイント（フックメソッド）の追加:
    - `should_respond_to_message`: メッセージに応答するかどうかを決定
    - `get_additional_introduction_info`: 自己紹介に追加情報を提供

- 以前の変更（自己紹介機能）:
  - `main_bot.py`: ボット起動時に自己紹介メッセージを送信する機能
  - `secondary_bot.py`: 同様に自己紹介機能（応答確率も表示）
  - 自己紹介メッセージの内容:
    - ボットの名前
    - 性格
    - 話し方
    - 興味・関心
    - 背景設定（存在する場合）
    - 使用しているAIモデル
    - 会話への招待メッセージ

- Memory Bank関連の過去の変更:
  - `memory-bank/` ディレクトリを作成
  - 以下のコアファイルを確立:
    - `projectbrief.md`: 基本文書（コア要件と目標を定義）
    - `productContext.md`: 目的、解決する問題、ユーザー体験の目標
    - `systemPatterns.md`: アーキテクチャ、設計パターン、コンポーネントの関係
    - `techContext.md`: 技術、制約、依存関係
    - `activeContext.md`: このファイル（現在の焦点と決定事項を追跡）
    - `progress.md`: 実装状況を追跡

## Next Steps
1. 基底クラスを使用した新しいボットの追加検討
2. 共通機能のテストと調整
3. 他のボット機能の拡張検討（例：特定のコマンドへの応答、定期的なトピック提案など）
4. Memory Bank関連の次のステップ:
   - Memory Bankシステムのさらなるテスト
   - 使用状況に基づくドキュメントの改良
   - 定期的な更新プロトコルの確立

## Active Decisions and Considerations

### Discord Bot構造
- 基底クラスと子クラスの責任分担
- フックメソッドを使用した拡張性の確保
- 新しいボットタイプの追加しやすさ

### Discord Bot機能
- 自己紹介メッセージの内容と形式
- 複数ボット間の相互作用の最適化
- ユーザー体験の向上方法

### Documentation Depth
- 包括的なドキュメントと読みやすさのバランス
- 重要な情報のハイライト
- 効率的なナビゲーションのための情報構造

### Update Frequency
- ドキュメント更新の最適な頻度の決定
- 必須更新のトリガーの特定
- メンテナンスのオーバーヘッドとドキュメントの正確性のバランス

### Extension Strategy
- 追加のコンテキストファイルを作成する基準の定義
- 拡張機能の命名規則の確立
- コアファイルと拡張ファイル間の明確な関係の維持

## Current Questions
- 基底クラスの設計は十分に柔軟で拡張可能か？
- 将来追加される可能性のあるボットタイプに対応できるか？
- 共通化によってコードの保守性はどの程度向上したか？
- Discord Botの自己紹介機能はユーザー体験をどのように向上させるか？
- 複数のボットが同時に自己紹介する場合、どのように調整すべきか？
- Memory Bankはプロジェクトの複雑さに応じてどのようにスケールするか？
- Memory Bankの有効性を測定するための最適な指標は何か？
- 読み取りプロトコルの効率をどのように最適化できるか？

## Recent Insights
- 基底クラスを使用することで、コードの重複が大幅に削減された
- フックメソッドパターンにより、子クラスでの拡張が容易になった
- 新しいボットタイプの追加が簡素化された
- Discord Botの自己紹介機能により、ユーザーはボットの特性をすぐに理解できる
- キャラクター設定に基づいた自己紹介は、ボットの個性を強調する
- 階層的なドキュメント構造により、明確な情報の流れが提供される
- ファイル間の関心事の分離により、更新の複雑さが軽減される
- Mermaidダイアグラムにより、システム関係の理解が向上する
- 必須の読み取りプロトコルにより、一貫したコンテキスト認識が確保される
